---
# pulled some of this from Amber's climate report .Rmd for us to modify: https://github.com/nationalparkservice/CCRP-Exposure-Reports/blob/main/CCExposure.Rmd
params:
#  park_code: "BRCA" # eventually we will have a render script where we can map over park parameter names here
  park_name: "Bryce Canyon National Park"
theme: united
output:
  word_document:
    reference_docx: template.docx
    fig_width: 7
    fig_caption: true
    #toc: yes
    #toc_depth: 2
#bibliography: ExposureReports.bib
#csl: ecology.csl
editor_options: 
  markdown: 
    wrap: 79
---

```{r setup, include=FALSE}
# set chunk defaults
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE,
                      error = FALSE,
                      message = FALSE,
                      fig.width = 8)
                      
                      
# read in libraries
source("setup.R")
library(scales)
library(tmap)

# set parameters
## path to data folder (from project directory)
path <- "data/park/"
## park code for this report
park <- "BRCA"


# read in data
load(paste0(path, "/", park, "/", park, "_report_data.RData"))
## terra object issue when saving as .RData, so saved as separate .tif
wbm_30y <- terra::rast(paste0(path, "/", park, "/", park, "_wbm_30yr_annual_rasters.tif"))

# match Amber's 'Appendix_Script.R' to create env vars to use for report: https://github.com/nationalparkservice/CCRP-Exposure-Reports/blob/main/Appendix_Script.R
#source("Appendix-Script.R")
```

---
subtitle: `r report_name`
---

::: {custom-style="H1 box"}
Key Findings
:::

::: {custom-style="Text box"}
High level summary of key findings. Metrics such as projected change in runoff,
etc. -- need to write report first.
:::

**Recommended Citation**

```{r, echo=FALSE, fig.width=8}
# CM: I for the life of me cannot get an image to fit to the width of the page and be centered
knitr::include_graphics("data/all/Report_Figures/BRCA.avif")
```

\newpage

## Project Background

Rising temperatures, changing precipitation patterns, stronger storms, and
other climatic changes are evident across America’s national parks. These
changes have the potential to impact the natural, cultural, and built resources
of our parks, which in turn can impact opportunities to visit and recreate in
these spaces. The National Park Service (NPS) has developed guidance and
resources to help parks incorporate climate considerations into their planning
processes, emphasizing that climate-informed plans should:

1)  Develop forward-looking goals that consider future climatic conditions
    according to the climate projections.

2)  Consider more than one scenario of the future when developing management
    strategies and actions.

This climate change vulnerability assessment (CCVA) considers how historic and
projected changes in climate (i.e., temperature and precipitation) and
hydrology (e.g., streamflow, recharge, extreme events, etc.) will potentially
impact water supplies at `r park_name`. Projections for future climate and
hydrologic conditions utilize methods that consider many ways that the future
climate might evolve in the area surrounding `r park_name`. These projections
are intended to help parks make short- and long-term decisions that avoid
surprises and costly mistakes.

## Regional Context

The Intermountain West is already experiencing warming temperatures, shorter
winters with less snowfall, and increased drought. This is leading to more
extreme heat events, a higher risk of wildfires, and generally less water
availability. Climate-related changes in water may impact park water resources
in many ways, including:

-   **Reduced snowpack and earlier melt:** Rising temperatures will lead to a
    decrease in winter snowfall and an earlier spring melt. This will result in
    less water being stored in snowpack, which is a critical source for
    replenishing rivers and streams throughout the year.

-   **Increased droughts and water scarcity:** With less snowpack and altered
    precipitation patterns, droughts are expected to become more frequent and
    severe. This will lead to decreased streamflow, lower reservoir levels, and
    potential water shortages for agriculture, municipalities, and ecosystems.

-   **Shifts in Streamflow Timing:** Earlier snowmelt will cause peak
    streamflow to occur earlier in the spring, potentially leading to increased
    likelihood of flooding during that time. However, with less overall water
    stored as snow, streamflow will likely be lower during the summer months
    when water demands are typically highest.

-   **Changes in Precipitation Patterns:** While overall precipitation may not
    change dramatically, the pattern of precipitation is expected to shift.
    There might be an increase in extreme precipitation events (heavy rain and
    snowfall) interspersed with longer dry periods. This can lead to flash
    flooding and soil erosion during heavy rain events, while longer dry
    periods exacerbate drought conditions.

-   **Potential Impacts on Water Quality:** Lower streamflow can lead to
    increased water temperature and reduced dilution of pollutants. This can
    have negative consequences for aquatic ecosystems and water quality for
    human consumption.

-   **Feedback loops:** Complex feedbacks between climate and visitation,
    vegetation, wildfires, land management, and human water use, among others,
    have have potential to further impact water supplies in ways that are
    difficult or impossible to predict.

## `r park_name`

### BRCA Water Supply

*map of brca, watersheds, water supply point + color watershed, at some point
centroids (appendix)*

```{r park_map, fig.width=5, echo = FALSE, message = FALSE, warning = FALSE}
tm_shape(park_boundary) +
  tm_polygons(col = "darkgreen", alpha = 0.25) +
  tm_shape(st_union(watersupply_watershed)) +
  tm_borders(col = "gold1", lwd = 5) +
  tm_shape(POD_all) +
  tm_dots(col = "black", alpha = 0.50, size = 0.25) +
  tm_shape(POD_supply) +
  tm_dots(col = "red", size = 0.5) +
  tm_scale_bar() +
  tm_add_legend("fill", col = "gold1", labels = "Water Supply Watershed") +
  tm_add_legend("symbol", col = "black", labels = "All NPS PODs") +
  tm_add_legend("symbol", col = "red", labels = paste0(park, " Water Supply"))+
  tm_layout(
    title = "BRCA Water Supply",
    frame = FALSE,
    legend.outside = TRUE,
    legend.outside.size = 0.5
  )

```

THIS IS A FILLER SET OF FIGURES \_ NEED SOMETHING TO ILLUSTRATE CONCEPT HERE
![Historic Temperature
Change](https://climatereanalyzer.org/clim/explore/img/prism_conus-lc_t2anom_2001-2012_minus_1979-2000.png){width="45%"}
![Historic Precipitation
Change](https://climatereanalyzer.org/clim/explore/img/prism_conus-lc_prcpanom_2001-2012_minus_1979-2000.png){width="45%"}

```{r background_fig}
# Figure of Park and changing precipitation in US
## CM - Maybe nix this for now, put in appendix in the future? Focusing on BRCA specific stuff here instead
```

### Mapped Change in Runoff

*map of projected change in runoff for both CFs and both future time periods*

```{r}
# create change maps, CM single example: 2055  hot dry change for runoff

runoff_change_2055 <- wbm_30y[[grepl(
pattern = paste(select_cfs[select_cfs$CF == "Hot Dry", GCM], "runoff", "2040_2069", sep = "_"),
x = names(wbm_30y)
)]] - wbm_30y[[grepl(
pattern = paste("gridmet_historical", "runoff", "1981_2010", sep = "_"),
x = names(wbm_30y)
)]]

# CM draft code to make one map
tm_shape(runoff_change_2055) +
      tm_raster(style = "cont",
                palette = "RdBu",
                legend.reverse = T,
                title = "Predicted Change in Runoff for 2040-2069") +
      tm_shape(park_boundary) +
      tm_borders() +
      tm_compass(position = "left") +
      tm_scale_bar(position = "left") +
      tm_layout(frame = FALSE,
                legend.outside = TRUE,
                legend.outside.size = 0.25,
                legend.title.size = 0.5
      ) 
```

### Monthly Change in Runoff

*timeseries change in runoff for two CFs*

# Water Supply

Precipitation that falls to the ground as rain or snow can follow various
paths:

-   Some infiltrates the soil, recharging groundwater and potentially
    sustaining plant life.

-   Some evaporates back into the atmosphere, especially from surfaces like
    leaves and open water.

-   A small portion might be stored as surface water in lakes, ponds, or
    wetlands.

-   The rest flows across the land surface as runoff, eventually feeding
    streams, rivers, and ultimately the ocean.

Each path represents a component of the "water budget". A water budget is like
a financial budget for water. It tracks all the water that enters (rain, snow),
exits (evapotranspiration, runoff), and gets stored (recharged groundwater,
soil moisture) in the system. At most National Parks, runoff and recharge make
up the vast majority of water that replenishes park water supplies (i.e.,
streams, aquifers, and springs). Together recharge and runoff can be thought of
as the "sustainable supply" to the system.

Analyzing historical data provides a valuable starting point for estimating
future water supplies. By studying changes in recharge and runoff patterns, we
can extrapolate trends to identify potential future scenarios. Water balance
models, which utilize historical temperature and precipitation data, can be
used to quantify the various components of a region's water budget over time.
However, these models have limitations. Climate change can introduce complex
feedback loops that render historical trends unreliable for predicting future
conditions. To address this challenge, we employ Global Climate Models (GCMs).
GCMs provide more accurate projections of future temperature and precipitation,
which can then be incorporated into water balance models.

![Figure X - A schematic representation of the water budget for a National
Park.](data/all/Report_Figures/NPS_WBM2.png){width="90%"}

The Intermountain Region faces a unique set of climate challenges. Following
best practices outlined by the National Park Service (NPS), we select a
specific range of GCMs that represent divergent, plausible, and relevant future
climate scenarios for the region. These scenarios encompass a spectrum of
possibilities, ranging from "Hot Dry" to "Warm Wet." This approach allows us to
explore a range of potential future conditions to develop robust water
management strategies.

### Historic changes in water balance

At `r park_name`, historical changes in the water budget include:

-   `r magnitude[magnitude$vars == "runoff_in" & magnitude$cf == "Historical",]$dir`
    in sustainable water supply (i.e., runoff + recharge) of approximately
    `r magnitude[magnitude$vars == "runoff_in" & magnitude$cf == "Historical",]$slope`
    acre-feet per year. The timing of spring runoff is
    `r spring_runoff_yearly_change$dir[1]` by approximately
    `r spring_runoff_yearly_change$slope_round[1]` days per year.

-   
    `r magnitude[magnitude$vars == "accumswe_in" & magnitude$cf == "Historical",]$dir`
    in annual snow water equivalent (SWE) by on average
    `r``magnitude[magnitude$vars == "accumswe_in" & magnitude$cf == "Historical",]$slope`acre-feet
    per year.

-   `r magnitude[magnitude$vars == "aet_in" & magnitude$cf == "Historical",]$dir`
    in evapotranspiration by an average of
    `r magnitude[magnitude$vars == "aet_in" & magnitude$cf == "Historical",]$slope`
    acre-feet per year.

-   \

### Projected changes in the water balance

Future projections for the "Warm Wet" scenario show `r runoff_magnitude$dir[3]`
on average `r runoff_magnitude$slope[3]` acre-feet per year with corresponding
shifts in the timing of spring runoff that are
`r spring_runoff_yearly_change$dir[3]` by about
`r spring_runoff_yearly_change$slope_round[3]` days per year. Future
projections for the "Hot Dry" scenario show `r runoff_magnitude$dir[2]` on
average `r runoff_magnitude$slope[2]` acre-feet per year with corresponding
shifts in the timing of spring runoff that are
`r spring_runoff_yearly_change$dir[2]` by about
`r spring_runoff_yearly_change$slope_round[2]` days per year.

RUNOFF annual timeseries data for historic, warm wet, hot dry (include trendlines) AND/OR the median DOY plots (might want both types for runoff...?)


```{r wbm_timeseries, fig.width=6, fig.height=3, echo = FALSE, message = FALSE, warning = FALSE}

ggplot(centroid_annual %>% ungroup() %>%
         dplyr::select(y, cf, tavg_f, precip_in, accumswe_in,aet_in) %>%
         pivot_longer(cols = -c(cf,y), values_to = "vals", names_to = "vars") %>%
         mutate(name = case_when(vars == "accumswe_in" ~ "SWE (in)",
                          vars == "aet_in" ~ "AET (in)",
                          vars == "precip_in" ~ "Precipitation (in)",
                          vars == "tavg_f" ~ "Temperature (F)")), 
       aes(x = y, y = vals, color = cf)) + 
  geom_line(size = 0.5) + 
  geom_smooth(span = .2, size = 1, se = FALSE) +
  labs(x = "", y = "Value") +
  scale_color_manual("",values = c("darkgray","red","dodgerblue3")) +
  theme_bw() +
  facet_wrap(~ factor(name, levels = c('Temperature (F)', 'Precipitation (in)', 
                                       'SWE (in)', 'AET (in)')), 
             scales = "free", ncol = 2) 
  
```
```{r wbm_doy, fig.width=6, fig.height=3, echo = FALSE, message = FALSE, warning = FALSE}
ggplot(doy %>%
         filter(vars %in% c("tavg_f","aet_in", "precip_in", "accumswe_in")), 
       aes(x = ym, y = vals, color = cf)) + 
  geom_line(size = 0.5) + 
  geom_smooth(span = .2, size = 1, se = FALSE) +
  scale_x_date(date_breaks = "2 month", date_labels =  "%b")  + 
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  facet_wrap(~ factor(name, levels = c('Temperature (F)', 'Precipitation (in)', 
                                      'SWE (in)', 'AET (in)')), 
             scales = "free", ncol = 2) +
  labs(x = "", y = "Value") +
  scale_color_manual("",values = c("darkgray","red","dodgerblue3"))
```

```{r runoff_time, fig.width=5, fig.height=3, echo = FALSE, message = FALSE, warning = FALSE}
a <- ggplot(centroid_annual %>% ungroup() %>%
         dplyr::select(y, cf, runoff_in) %>%
         pivot_longer(cols = -c(cf,y), values_to = "vals", names_to = "vars") %>%
         mutate(name = case_when(vars == "runoff_in" ~ "Runoff (in)")),
       aes(x = y, y = vals, color = cf)) + 
  geom_line(size = 0.5) + 
  geom_smooth(span = .2, size = 1, se = FALSE) +
  labs(x = "", y = "") +
  scale_color_manual("",values = c("darkgray","red","dodgerblue3")) +
  theme_bw() +
  ylab("Runoff (in)")

b <- ggplot(doy %>% filter(vars == "runoff_in"), aes(x = ym, y = vals, color = cf)) + 
  geom_line(size = 0.5) + 
  geom_smooth(span = .2, size = 1, se = FALSE) +
  scale_x_date(date_breaks = "2 month", date_labels =  "%b")  + 
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(x = "", y = "") +
  scale_color_manual("",values = c("darkgray","red","dodgerblue3"))

ggarrange(a,b, common.legend = TRUE, legend="bottom", align = 'h')

```


```{r runoff_thresholds, fig.width=5, fig.height=3, echo = FALSE, message = FALSE, warning = FALSE}
a=ggplot() +
  geom_line(data = centroid_annual, aes(x = y, y = runoff_in, color = cf)) +
  geom_hline(yintercept = historic$QLOW, linetype = "dashed") +
  geom_hline(yintercept = historic$QHIGH, linetype = "dashed") +
  geom_point(data = filter(streak_check, low_year == 1 | high_year == 1), aes(x = y, y = runoff_in, color = cf)) +
  theme_minimal() +
  labs(x = "",y = "Runoff (in)",color = "") +
  scale_color_manual("",values = c("darkgray","red","dodgerblue"))

b = ggplot() +
  geom_point(data = streak_check, aes(x = y, y = low_year - 1, color = cf, fill = cf), shape =22,cex = 3) +
  geom_point(data = streak_check, aes(x = y, y = high_year, color = cf, fill = cf), shape = 22, cex = 3) +
  scale_y_continuous(breaks = c(0, 1),
    labels = c(expression(paste("< ", P[10], " Historic")), 
            expression(paste("> ", P[90], " Historic")))) +
  ylab("") +
  theme_minimal() +
  theme(legend.position = "none") + 
  scale_color_manual("",values = c("darkgray","red","dodgerblue")) + 
  scale_fill_manual("",values = c("darkgray","red","dodgerblue")) 

ggarrange(a, b, ncol =1, align = "v", heights = c(3,1))

```




Two plots side-by-side of: Days with runoff <= Q05 historic per year + Days with runoff >= Q95 historic per year
Three largest "dry periods" and "wet periods" total runoff quantities and extent (number years)
Two plots side-by-side of: Runoff timing changes… find the month with the most runoff. And, the month with the least runoff

ADD MORE VARIABLES: - Frequency of extreme dry years - Changes in precipitation
and snow -- these describe changes in runoff

# Water Demand

When assessing water supply vulnerability to climate change, it's crucial to
consider not only changes in supply, but also water demand. Climate change can
directly increase demand through factors like rising temperatures, leading to
more evaporation and irrigation needs. However, demand can also rise due to
population growth, economic development, or changes in water use patterns. By
considering both supply and all sources of demand, we get a more complete
picture of potential water stress in a region under climate change. This allows
for more effective water management strategies that address both potential
reductions in supply and potential increases in demand.

Visitors are a major driver of water demand at National Parks. At
`r park_name`, annual visitation for the years 2013-2023 increased by
`r visitor_2013_2023_change` % compared to the previous 10 years (2003-2013).
Using multiple linear regression models to project average annual visitation for 
the decade preceding 2053  `r visitor_2043_2053_change` % greater than in
2023.

Climate change will also likely affect visitation patterns. Where, when, and
how many people visit parks is likely to change with continued warming. For
example, visitors may avoid extremely warm months in low-latitude parks and the
visitation season may extend across additional weeks to months at northern
parks. Where temperatures are projected to change drastically, so to may trends
and patterns in water demand. At `r park_name`, temperature is expected to 
`r magnitude[magnitude$vars == "tavg_f" & magnitude$cf == "Hot Wet",]$dir`.
Therefore, visitation may XXX[increase/decrease/shift]. different times of
year.

```{r demand, fig.width=5, fig.height=3, message = FALSE, warning = FALSE}

# Fix formatting
ggplot(centroid_annual) +
  geom_line(aes(x = y, y = MLR_demandAp_fit, color = cf)) +
  geom_ribbon(aes(x = y, ymin =  MLR_demandAp_lwr, ymax =  MLR_demandAp_upr, 
              color = cf, fill = cf), alpha = 0.2, linewidth = 0) + 
  geom_line(aes(x = y, 
                y = use_acre_feet),
                color = "black") + 
  scale_color_manual("Modeled", values = c("darkgray","darkred","dodgerblue4")) +
  scale_fill_manual("Modeled", values = c("black","darkred","dodgerblue4")) +
  labs(x = "", y = "Annual Water Demand (af)") + 
  xlim(1980,2080) + ylim(-100,350) + theme_bw()

```

# Vulnerability

Parks face water supply vulnerability when the balance between available water
(supply) and water use (demand) is disrupted. A resilient system maintains a
steady supply that meets current water needs. However, future challenges arise
if water availability shrinks significantly, even with stable demand.\
Conversely, even minor changes in supply can be overwhelmed by a sharp rise in
water use. To assess this vulnerability, we calculate a supply-to-demand ratio
(S:D) and track its changes over time.

DESCRIBE FIGURE BELOW (EVENTUALLY AUTOMATE)

```{r s_d_ratio, fig.width=5, fig.height=3, message = FALSE, warning = FALSE}


ggplot(centroid_annual, aes(x = y, y = S_D_ratio, color = cf)) +
  geom_line() +
  geom_smooth(method = "lm",aes(fill= cf)) +
  #geom_ribbon(aes(x = y, ymin =  S_D_ratio_lwr, ymax =  S_D_ratio_upr, 
  #            color = cf, fill = cf), alpha = 0.2, linewidth = 0) + 
  scale_color_manual("", values = c("black","red","dodgerblue3")) +
  scale_fill_manual("", values = c("black","red","dodgerblue3")) +
  #scale_fill_manual("", values = c("black","darkred","dodgerblue4")) +
  labs(x = "", y = "S-D Ratio") + 
  theme_bw()

```

# Recommendations

If doing a major water supply project... (something like...) consider: - ADD 30
year change figures to and text about suggestions for developing in water
supplies that are more resilient to climate change... - ADD plot of diversion
points near watershed. - note to consider human actions that could be
exacerbated by a changing climate.

Other (To Dos)

-   Drought

-   Come up with supply/demand ratio. Plot changes through time. If above
    threshold, then...

-   General water demand in area - by huc (??) or county (USGS).

### Citations

1.  <https://www.nps.gov/subjects/climatechange/planning.htm>

Runyon et al., 2024

Water balance model pub
